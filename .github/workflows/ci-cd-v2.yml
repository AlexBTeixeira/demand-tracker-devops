name: CI/CD Pipeline V2 - Demand Tracker

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]

env:
  PYTHON_VERSION: "3.9"
  POETRY_VERSION: "1.6.1"

jobs:
  # Preparação e cache de dependências
  setup:
    name: Setup e Cache de Dependências
    runs-on: ubuntu-latest
    outputs:
      cache-hit: ${{ steps.cache-deps.outputs.cache-hit }}
      
    steps:
    - name: Checkout do código
      uses: actions/checkout@v4

    - name: Configurar Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Cache de dependências pip
      id: cache-deps
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/pip
          venv
        key: ${{ runner.os }}-python-${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-python-${{ env.PYTHON_VERSION }}-

    - name: Criar ambiente virtual e instalar dependências
      if: steps.cache-deps.outputs.cache-hit != 'true'
      run: |
        python -m venv venv
        source venv/bin/activate
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt
        pip install pytest flake8 black isort bandit safety coverage pytest-cov pytest-xdist

  # análise de segurança
  security:
    name: Análise de Segurança
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
    - name: Checkout do código
      uses: actions/checkout@v4

    - name: Configurar Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Restaurar cache de dependências
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/pip
          venv
        key: ${{ runner.os }}-python-${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements.txt') }}

    - name: Ativar ambiente virtual
      run: source venv/bin/activate

    - name: Verificar vulnerabilidades com Safety
      run: |
        source venv/bin/activate
        safety check --json --output safety-report.json || true

    - name: Análise de segurança com Bandit
      run: |
        source venv/bin/activate
        bandit -r . -f json -o bandit-report.json -x "*/tests/*,*/venv/*" || true

    - name: Upload dos relatórios de segurança
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports
        path: |
          safety-report.json
          bandit-report.json

  # Job de qualidade de código
  code-quality:
    name: Qualidade de Código
    runs-on: ubuntu-latest
    needs: setup

    steps:
    - name: Checkout do código
      uses: actions/checkout@v4

    - name: Configurar Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Restaurar cache de dependências
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/pip
          venv
        key: ${{ runner.os }}-python-${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements.txt') }}

    - name: Ativar ambiente virtual
      run: source venv/bin/activate

    - name: Verificar e formatar código com Black
      run: |
        source venv/bin/activate
        # Primeiro tenta formatar, depois verifica se há mudanças
        black --diff . || true
        black --check --diff . || (echo "❌ Arquivos precisam ser formatados com Black. Execute: black ." && exit 1)

    - name: Verificar e organizar imports com isort
      run: |
        source venv/bin/activate
        # Primeiro tenta organizar, depois verifica se há mudanças
        isort --diff . || true
        isort --check-only --diff . || (echo "❌ Imports precisam ser organizados com isort. Execute: isort ." && exit 1)

    - name: Análise estática com Flake8
      run: |
        source venv/bin/activate
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --format=json --output-file=flake8-report.json || true
        flake8 . --count --max-complexity=10 --max-line-length=88 --statistics

    - name: Upload do relatório Flake8
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: flake8-report
        path: flake8-report.json

  # Job de testes unitários
  unit-tests:
    name: Testes Unitários
    runs-on: ubuntu-latest
    needs: setup
    strategy:
      matrix:
        python-version: ["3.8", "3.9", "3.10"]
      fail-fast: false

    steps:
    - name: Checkout do código
      uses: actions/checkout@v4

    - name: Configurar Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Instalar dependências
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest coverage pytest-cov pytest-xdist pytest-html

    - name: Executar testes com cobertura
      run: |
        export PYTHONPATH=$PYTHONPATH:$(pwd)
        pytest tests/ \
          --cov=. \
          --cov-report=xml \
          --cov-report=html \
          --cov-report=term-missing \
          --junit-xml=pytest-results.xml \
          --html=pytest-report.html \
          --self-contained-html \
          -v

    - name: Upload da cobertura para Codecov
      uses: codecov/codecov-action@v4
      if: matrix.python-version == '3.9'
      with:
        file: coverage.xml
        flags: unittests
        name: codecov-umbrella

    - name: Upload dos relatórios de teste
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-reports-python-${{ matrix.python-version }}
        path: |
          coverage.xml
          htmlcov/
          pytest-results.xml
          pytest-report.html

  # Job de build
  build:
    name: Build da Aplicação
    runs-on: ubuntu-latest
    needs: [security, code-quality, unit-tests]
    if: always() && needs.unit-tests.result == 'success'

    steps:
    - name: Checkout do código
      uses: actions/checkout@v4

    - name: Configurar Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Instalar dependências
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Build da aplicação
      run: |
        python -m compileall .
        echo "Build concluído com sucesso!"

    - name: Build da imagem Docker (se Dockerfile existir)
      if: hashFiles('dockerfile') != '' || hashFiles('Dockerfile') != ''
      run: |
        docker build -t demand-tracker:${{ github.sha }} .
        docker save demand-tracker:${{ github.sha }} > demand-tracker-image.tar

    - name: Upload do artefato Docker
      uses: actions/upload-artifact@v4
      if: hashFiles('dockerfile') != '' || hashFiles('Dockerfile') != ''
      with:
        name: docker-image
        path: demand-tracker-image.tar

  # Job de resumo e report
  ci-summary:
    name: Resumo do CI
    runs-on: ubuntu-latest
    needs: [security, code-quality, unit-tests, build]
    if: always()

    steps:
    - name: Exibir resumo dos jobs
      run: |
        echo "========================================================"
        echo "                   PIPE CI/CD V2"
        echo "========================================================"
        echo "Segurança: ${{ needs.security.result }}"
        echo "Qualidade: ${{ needs.code-quality.result }}"
        echo "Teste Unitário: ${{ needs.unit-tests.result }}"
        echo "Build: ${{ needs.build.result }}"
        echo "========================================================"
        
        if [[ "${{ needs.unit-tests.result }}" == "success" && "${{ needs.build.result }}" == "success" ]]; then
          echo "CI PASSOU"
        else
          echo "CI FALHOU"
          exit 1
        fi

  # Job de instruções de deploy 
  cd-instructions:
    name: Instruções de Deploy (CD)
    runs-on: ubuntu-latest
    needs: [ci-summary]
    if: >
      always() && 
      needs.ci-summary.result == 'success' &&
      github.event_name == 'push' && 
      github.ref == 'refs/heads/main'
    
    steps:
      - name: Exibir instruções de deploy
        run: |
          echo "O deploy para o AWS deve ser iniciado manualmente."
          echo "Isto é necessário devido às restrições do AWS Academy (sem criação de IAM Roles)."
          echo ""
          echo "PASSOS PARA O DEPLOY:"
          echo "1. Acesse o console do CloudFormation e pegue o IP da 'ManagementInstanceIP'."
          echo "2. Conecte-se via SSH: ssh -i sua-chave.pem ec2-user@<INSTANCIA>"
          echo "3. Dentro da instância, execute o script de deploy:"
          echo ""
          echo "O script 'deploy.sh' irá construir o Docker, fazer o push para o ECR e atualizar o ECS."
