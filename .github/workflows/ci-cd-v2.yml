name: CI/CD Pipeline v2 - Demand Tracker (Melhorado)

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]

env:
  PYTHON_VERSION: "3.9"
  POETRY_VERSION: "1.6.1"

jobs:
  # Job de prepara√ß√£o e cache de depend√™ncias
  setup:
    name: üîß Setup e Cache de Depend√™ncias
    runs-on: ubuntu-latest
    outputs:
      cache-hit: ${{ steps.cache-deps.outputs.cache-hit }}
      
    steps:
    - name: üì• Checkout do c√≥digo
      uses: actions/checkout@v4

    - name: üêç Configurar Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: üì¶ Cache de depend√™ncias pip
      id: cache-deps
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/pip
          venv
        key: ${{ runner.os }}-python-${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-python-${{ env.PYTHON_VERSION }}-

    - name: üî® Criar ambiente virtual e instalar depend√™ncias
      if: steps.cache-deps.outputs.cache-hit != 'true'
      run: |
        python -m venv venv
        source venv/bin/activate
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt
        pip install pytest flake8 black isort bandit safety coverage pytest-cov pytest-xdist

  # Job de an√°lise de seguran√ßa
  security:
    name: üîí An√°lise de Seguran√ßa
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
    - name: üì• Checkout do c√≥digo
      uses: actions/checkout@v4

    - name: üêç Configurar Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: üì¶ Restaurar cache de depend√™ncias
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/pip
          venv
        key: ${{ runner.os }}-python-${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements.txt') }}

    - name: üîß Ativar ambiente virtual
      run: source venv/bin/activate

    - name: üõ°Ô∏è Verificar vulnerabilidades com Safety
      run: |
        source venv/bin/activate
        safety check --json --output safety-report.json || true

    - name: üîç An√°lise de seguran√ßa com Bandit
      run: |
        source venv/bin/activate
        bandit -r . -f json -o bandit-report.json -x "*/tests/*,*/venv/*" || true

    - name: üìä Upload dos relat√≥rios de seguran√ßa
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports
        path: |
          safety-report.json
          bandit-report.json

  # Job de qualidade de c√≥digo
  code-quality:
    name: üìã Qualidade de C√≥digo
    runs-on: ubuntu-latest
    needs: setup

    steps:
    - name: üì• Checkout do c√≥digo
      uses: actions/checkout@v4

    - name: üêç Configurar Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: üì¶ Restaurar cache de depend√™ncias
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/pip
          venv
        key: ${{ runner.os }}-python-${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements.txt') }}

    - name: üîß Ativar ambiente virtual
      run: source venv/bin/activate

    - name: ‚ö´ Verificar formata√ß√£o com Black
      run: |
        source venv/bin/activate
        black --check --diff .

    - name: üìê Verificar imports com isort
      run: |
        source venv/bin/activate
        isort --check-only --diff .

    - name: üîç An√°lise est√°tica com Flake8
      run: |
        source venv/bin/activate
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --format=json --output-file=flake8-report.json || true
        flake8 . --count --max-complexity=10 --max-line-length=88 --statistics

    - name: üìä Upload do relat√≥rio Flake8
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: flake8-report
        path: flake8-report.json

  # Job de testes unit√°rios
  unit-tests:
    name: üß™ Testes Unit√°rios
    runs-on: ubuntu-latest
    needs: setup
    strategy:
      matrix:
        python-version: ["3.8", "3.9", "3.10", "3.11"]
      fail-fast: false

    steps:
    - name: üì• Checkout do c√≥digo
      uses: actions/checkout@v4

    - name: üêç Configurar Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: üî® Instalar depend√™ncias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest coverage pytest-cov pytest-xdist pytest-html

    - name: üß™ Executar testes com cobertura
      run: |
        export PYTHONPATH=$PYTHONPATH:$(pwd)
        pytest tests/ \
          --cov=. \
          --cov-report=xml \
          --cov-report=html \
          --cov-report=term-missing \
          --junit-xml=pytest-results.xml \
          --html=pytest-report.html \
          --self-contained-html \
          -v

    - name: üìä Upload da cobertura para Codecov
      uses: codecov/codecov-action@v3
      if: matrix.python-version == '3.9'
      with:
        file: coverage.xml
        flags: unittests
        name: codecov-umbrella

    - name: üìã Upload dos relat√≥rios de teste
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-reports-python-${{ matrix.python-version }}
        path: |
          coverage.xml
          htmlcov/
          pytest-results.xml
          pytest-report.html

  # Job de testes de integra√ß√£o (se existirem)
  integration-tests:
    name: üîó Testes de Integra√ß√£o
    runs-on: ubuntu-latest
    needs: [setup, unit-tests]
    if: always() && needs.unit-tests.result == 'success'

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: test_password
          MYSQL_DATABASE: test_db
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
    - name: üì• Checkout do c√≥digo
      uses: actions/checkout@v4

    - name: üêç Configurar Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: üî® Instalar depend√™ncias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest

    - name: üóÑÔ∏è Configurar banco de dados de teste
      run: |
        mysql -h127.0.0.1 -uroot -ptest_password test_db < sql/schema.sql
      if: hashFiles('sql/schema.sql') != ''

    - name: üîó Executar testes de integra√ß√£o
      env:
        DATABASE_URL: mysql://root:test_password@127.0.0.1:3306/test_db
      run: |
        export PYTHONPATH=$PYTHONPATH:$(pwd)
        # Assumindo que testes de integra√ß√£o est√£o marcados com @pytest.mark.integration
        pytest tests/ -m integration -v
      continue-on-error: true

  # Job de build da aplica√ß√£o
  build:
    name: üèóÔ∏è Build da Aplica√ß√£o
    runs-on: ubuntu-latest
    needs: [security, code-quality, unit-tests]
    if: always() && needs.unit-tests.result == 'success'

    steps:
    - name: üì• Checkout do c√≥digo
      uses: actions/checkout@v4

    - name: üêç Configurar Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: üî® Instalar depend√™ncias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: üèóÔ∏è Build da aplica√ß√£o
      run: |
        python -m compileall .
        echo "Build conclu√≠do com sucesso!"

    - name: üê≥ Build da imagem Docker (se Dockerfile existir)
      if: hashFiles('dockerfile') != '' || hashFiles('Dockerfile') != ''
      run: |
        docker build -t demand-tracker:${{ github.sha }} .
        docker save demand-tracker:${{ github.sha }} > demand-tracker-image.tar

    - name: üì¶ Upload do artefato Docker
      uses: actions/upload-artifact@v4
      if: hashFiles('dockerfile') != '' || hashFiles('Dockerfile') != ''
      with:
        name: docker-image
        path: demand-tracker-image.tar

  # Job de resumo e relat√≥rio final
  ci-summary:
    name: üìä Resumo do CI
    runs-on: ubuntu-latest
    needs: [security, code-quality, unit-tests, integration-tests, build]
    if: always()

    steps:
    - name: üìã Exibir resumo dos jobs
      run: |
        echo "========================================================"
        echo "           RESUMO DO PIPELINE CI v2"
        echo "========================================================"
        echo "üîí Seguran√ßa: ${{ needs.security.result }}"
        echo "üìã Qualidade de C√≥digo: ${{ needs.code-quality.result }}"
        echo "üß™ Testes Unit√°rios: ${{ needs.unit-tests.result }}"
        echo "üîó Testes de Integra√ß√£o: ${{ needs.integration-tests.result }}"
        echo "üèóÔ∏è Build: ${{ needs.build.result }}"
        echo "========================================================"
        
        if [[ "${{ needs.unit-tests.result }}" == "success" && "${{ needs.build.result }}" == "success" ]]; then
          echo "‚úÖ CI PASSOU COM SUCESSO!"
          echo "A aplica√ß√£o est√° pronta para deploy."
        else
          echo "‚ùå CI FALHOU!"
          echo "Verifique os jobs que falharam antes de fazer o deploy."
          exit 1
        fi

  # Job de instru√ß√µes de deploy (mantendo o CD original)
  cd-instructions:
    name: üìã Instru√ß√µes de Deploy (CD)
    runs-on: ubuntu-latest
    needs: [ci-summary]
    if: >
      always() && 
      needs.ci-summary.result == 'success' &&
      github.event_name == 'push' && 
      github.ref == 'refs/heads/main'
    
    steps:
      - name: üì¢ Exibir instru√ß√µes de deploy
        run: |
          echo "========================================================"
          echo "PASSO DE CI (TESTE E LINT) CONCLU√çDO COM SUCESSO!"
          echo "========================================================"
          echo "O deploy para o ambiente AWS (CD) deve ser iniciado manualmente."
          echo "Isto √© necess√°rio devido √†s restri√ß√µes do AWS Academy (sem cria√ß√£o de IAM Roles)."
          echo ""
          echo "PASSOS PARA O DEPLOY:"
          echo "1. Acesse o console do CloudFormation e pegue o IP da 'ManagementInstanceIP'."
          echo "2. Conecte-se via SSH: ssh -i sua-chave.pem ec2-user@<IP_DA_INSTANCIA>"
          echo "3. Dentro da inst√¢ncia, execute o script de deploy:"
          echo "   cd /home/ec2-user/app"
          echo "   ./deploy.sh"
          echo ""
          echo "O script 'deploy.sh' ir√° construir a imagem Docker, fazer o push para o ECR e atualizar o servi√ßo ECS."
          echo ""
          echo "üÜï MELHORIAS NO CI v2:"
          echo "- ‚úÖ Cache de depend√™ncias para builds mais r√°pidos"
          echo "- ‚úÖ An√°lise de seguran√ßa (Safety + Bandit)"
          echo "- ‚úÖ Verifica√ß√£o de formata√ß√£o (Black + isort)"
          echo "- ‚úÖ Testes em m√∫ltiplas vers√µes do Python"
          echo "- ‚úÖ Cobertura de c√≥digo detalhada"
          echo "- ‚úÖ Relat√≥rios HTML de testes"
          echo "- ‚úÖ Artefatos para an√°lise posterior"
          echo "- ‚úÖ Jobs paralelos para performance"
